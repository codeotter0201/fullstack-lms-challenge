# =============================================================================
# Docker Compose Configuration - Development Environment
# =============================================================================
#
# 此配置包含完整的 Waterball LMS 開發環境：
#   - PostgreSQL 15 (Database)
#   - Spring Boot Backend (Java 17)
#   - Next.js Frontend (Node 20)
#
# 啟動指令:
#   docker-compose up -d
#
# 停止指令:
#   docker-compose down
#
# 查看日誌:
#   docker-compose logs -f [service_name]
#
# 重新建置:
#   docker-compose up -d --build
#
# =============================================================================

version: '3.8'

services:
  # ---------------------------------------------------------------------------
  # PostgreSQL Database
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:15-alpine
    container_name: waterball-lms-db
    environment:
      POSTGRES_DB: waterball_lms
      POSTGRES_USER: wblms_user
      POSTGRES_PASSWORD: WbLms@2024!Dev
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - waterball-network
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Spring Boot Backend
  # ---------------------------------------------------------------------------
  backend:
    build:
      context: ../backend
      dockerfile: Dockerfile
    container_name: waterball-lms-backend
    environment:
      # Spring Profile
      SPRING_PROFILE: dev

      # Database Configuration
      DATABASE_URL: jdbc:postgresql://postgres:5432/waterball_lms
      DATABASE_USERNAME: wblms_user
      DATABASE_PASSWORD: WbLms@2024!Dev

      # JWT Configuration
      JWT_SECRET: dev-secret-key-must-be-at-least-256-bits-long-for-HS256-algorithm-security
      JWT_EXPIRATION: 86400000

      # Server Configuration
      SERVER_PORT: 8080

      # CORS Configuration（允許前端容器訪問）
      CORS_ALLOWED_ORIGINS: http://localhost:3000,http://frontend:3000
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - waterball-network
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Next.js Frontend
  # ---------------------------------------------------------------------------
  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    container_name: waterball-lms-frontend
    environment:
      # API Configuration（容器內部通訊使用 service name）
      NEXT_PUBLIC_API_BASE_URL: http://backend:8080/api

      # Application Configuration
      NEXT_PUBLIC_ENV: development
      NEXT_PUBLIC_APP_NAME: Waterball LMS
      NEXT_PUBLIC_APP_URL: http://localhost:3000

      # Feature Flags
      NEXT_PUBLIC_USE_REAL_API: "false"
      NEXT_PUBLIC_ENABLE_ANALYTICS: "false"
      NEXT_PUBLIC_ENABLE_ERROR_REPORTING: "false"
      NEXT_PUBLIC_DEBUG: "true"

      # Mock Configuration
      NEXT_PUBLIC_MOCK_DELAY: 500

      # LINE Login Configuration（R2 功能，暫時保留）
      NEXT_PUBLIC_LINE_CLIENT_ID: your_line_channel_id_here
      NEXT_PUBLIC_LINE_REDIRECT_URI: http://localhost:3000/api/auth/line/callback

      # CDN Configuration
      NEXT_PUBLIC_CDN_URL: https://cdn.waterballsa.tw

      # Performance
      NEXT_PUBLIC_IMAGE_QUALITY: 90
      NEXT_PUBLIC_ENABLE_LAZY_LOADING: "true"
    ports:
      - "3000:3000"
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - waterball-network
    restart: unless-stopped

# -----------------------------------------------------------------------------
# Volumes
# -----------------------------------------------------------------------------
volumes:
  postgres_data:
    driver: local

# -----------------------------------------------------------------------------
# Networks
# -----------------------------------------------------------------------------
networks:
  waterball-network:
    driver: bridge
    name: waterball-lms-network

# =============================================================================
# 備註
# =============================================================================
#
# 1. 服務啟動順序：
#    postgres → backend → frontend
#    使用 health check 和 depends_on 確保正確啟動順序
#
# 2. 網路配置：
#    - 所有服務在同一個 bridge 網路（waterball-lms-network）
#    - 容器間可透過 service name 互相訪問
#    - frontend → backend: http://backend:8080
#    - backend → postgres: postgresql://postgres:5432
#
# 3. 外部訪問：
#    - Frontend: http://localhost:3000
#    - Backend API: http://localhost:8080
#    - PostgreSQL: localhost:5432 (僅供開發工具連接)
#
# 4. CORS 設定：
#    - Backend 需要允許來自 frontend 容器的請求
#    - CORS_ALLOWED_ORIGINS 包含 localhost:3000 和 frontend:3000
#
# 5. Health Checks：
#    - postgres: pg_isready 檢查
#    - backend: /api/health 端點
#    - frontend: root path (/) 檢查
#
# 6. 重啟策略：
#    - unless-stopped: 除非手動停止，否則總是重啟
#    - 適合開發環境，容錯性高
#
# =============================================================================
